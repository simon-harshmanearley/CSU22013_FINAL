---
title: 'CSU22013: Design and implement a dashboard to visualise and compare commit
  activity for trending repositories on GitHub.'
output:
  html_document:
    df_print: paged
---

The following chunk utilises the MIT GitHub API found at, https://github.com/alisoft/github-trending-api#readme (Full license citation to be added). 

The purpose of using this API is to create a list of the top trending repositories on GitHub, to be used later in conjunction with the official GitHub API, which will allow access to the commit data of each individual repository.

The following code firstly accesses the API, and then retrieves a list of the top trending authors and repository names, in order to manually create a list of URLs to the commit data, which the official GitHub API will then use.

A URL to a repositories commit data is as follows:
"https://api.github.com/repos/", repo_author, "/", repo_name, "/commits"

```{r}
# Libraries
library(httr)
library(jsonlite)
library(furrr)
library(shiny)
library(shinyjs)
library(plotly)
library(dplyr)
library(tidyr)
library(scales)
library(ggplot2)

# Personal Access Token for GitHub API
API_PAT <<- c(Authorization = paste("Bearer", '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'))
PAGE_LIMITS <<- 5
```

Function to Create base URL, to which /commits or /languages can be appended. Daterange fetches either top repositories from last day, week, or month.

```{r}
API_1_create_urls <- function(date_range){
  
  # Call to MIT GitHub API to get information on current top trending repositories
  url <- "https://api.gitterapp.com/repositories?since=daily"
  response <- GET(url, query = list(since = date_range))
  repo_data <- content(response)
  
  # Retrieve list of top N authors
  repo_author <- lapply(repo_data, "[[", 1)
 
  # Retrieve list of top N repository names
  repo_name <- lapply(repo_data, "[[", 2)

# Function which manually creates URL to commit activity of each repository
  create_url <- function(repo_author, repo_name) {
  url <- paste0("https://api.github.com/repos/", repo_author, "/", repo_name)
  return(url)
  }

  # Create list of URLs to commit activity of top N repositories
  url <- mapply(create_url, repo_author, repo_name, SIMPLIFY = FALSE)
  url_list <- as.character(url)
  
  return(url_list)
}
```


Function which creates data frame of each repository, their languages and percentage of each language within the project

```{r}
# languageDataFrame
# Function to fetch language percentages per repository
create_language_dataframe <- function() {

  # Initialise list
  language_data_list <- list()
  
  # Loop through each URL
  for (url in GIT_URLS) {

    repo_name <-
      strsplit(url, "/")[[1]][6]  # Get repository name from URL
    url <- paste0(url, "/languages")
    
    response <- GET(url, add_headers(API_PAT))
    language_data <- content(response)

    if(length(language_data) == 0){
      GIT_URLS = GIT_URLS[-which(GIT_URLS == url)]
      next
    }
    
    # Convert language_data into a data frame
    language_df <- data.frame(
      repository = repo_name,
      language = names(language_data),
      percentage = unlist(language_data)
    )
    
    language_data_list[[repo_name]] <- language_df
  }
  
  # Combine all language dataframes into a single dataframe
  language_table <- bind_rows(language_data_list)
  
  # Pivot the data into wide format
  language_table <- language_table %>%
    pivot_wider(
      names_from = language,
      values_from = percentage,
      values_fill = 0
    )
  
  #tibble -> df
  language_table = as.data.frame(language_table)
  #colnames
  rownames(language_table) = language_table$repository
  language_table$repository <- NULL
  
  # Calculate the row sums
  row_sums <- rowSums(language_table)

  # Calculate the percentage of each column by row to 2 decimal places
  language_table <- round(language_table / row_sums, 2)
  
  return(language_table)
}
```


Function which filters languageDataFrame by programming language, returning the top 5 (or less if there are less than 5) repositories which contain the user specified language (e.g. Python)

```{r}
# filteredLanguageDataFrame
# Function to create data frame to display the top 5 trending repositories, filtering by programming language. "total" returns top 5 generally
create_filtered_top_n_language_dataframe <- function(language, language_df, n = 5) {
  
  if (language == "total") {
      # Select the top 5 repositories based on trendiness
      return(head(language_df, n))
  } 
  
  # Get the index of the chosen language in the data frame
  language_index <- which(colnames(language_df) == language)
    
  # Filter repositories with non-zero percentage of chosen language
  filtered_repositories <- language_df[language_df[, language_index] > 0, ]
    
  # Select repositories, considering the case of less than 5 repositories
  num_repositories <- min(nrow(filtered_repositories), n)
  top_repositories <- filtered_repositories[1:num_repositories, ]

  return(top_repositories)
}

#filteredLanguageDataFrame <- create_filtered_top_5_language_dataframe(targetLanguage)

```

Function which creates a data frame of every commit in the master branch of a repo. Each commit in data frame includes: Repository name, developer name, developer contact email, datetime commit published at

```{r}
# commitDataFrame
# Function which gets the entire commit history of x number of repositories from top trending
create_commits_dataframe <- function() {
  
  # Initialize an empty data frame to store the commit information
  cols = c('repo','dev_name','email','datetime')
  data_table = data.frame(matrix(nrow = 0, ncol = length(cols))) 
  colnames(data_table) = cols
  
  # Loop through each commit activity URL
  for (url in GIT_URLS) {
    
    url <- paste0(url, "/commits")
    
    page <- 1

    while (page <= PAGE_LIMITS) {
      page_url <- paste0(url, "?per_page=100&page=", page)
      response <- GET(page_url, add_headers(API_PAT))
      commit_data <- content(response)
      
      if (length(commit_data) == 0) {
        break  # No more commits on this page
      }
      
      df <- data.frame(
        repo = c(strsplit(unlist(lapply(commit_data, function (x) x$commit$tree$url)), "/")[[1]][6]),
        dev_name = c(unlist(lapply(commit_data, function (x) x$commit$author$name))),
        email = c(unlist(lapply(commit_data, function (x) x$commit$author$email))),
        datetime = c(unlist(lapply(commit_data, function (x) x$commit$author$date)))
      )
      

      data_table <- rbind(data_table, df) 
      page <- page + 1
    }
  
  }
  
  return(data_table)
}

```

```{r}
get_urls_from_list_of_repo_names  = function(language_df){
    filtered_urls <- list()
    for(url in GIT_URLS){
      name <- strsplit(url, "/")[[1]][6]
      if(name %in% rownames(language_df)){
        filtered_urls[name] <- url
      }
    }  
    
  return(filtered_urls)
}

```

```{r}

count_commits_by_DevRepo <- function(commits_df){
  return(aggregate(email ~ dev_name + repo, data = commits_df, FUN = length))
}


```




```{r}
# Graph 1: Languages

graph_languages <- function(languages_df){
  
  # Find columns where all values are 0
cols_to_remove <- colnames(language_df)[apply(language_df, 2, function(col) all(col == 0))]

# Remove the identified columns
language_df_filtered <- language_df[, !(colnames(language_df) %in% cols_to_remove)]
  
  language_matrix <- t(as.matrix(language_df_filtered))

# Plot the stacked bar chart
barplot(language_matrix, beside = FALSE,  names.arg = language_df$Repo,
        main = "Languages by Repository", xlab = "Repository", ylab = "Percentage",
        legend.text = names(colors), args.legend = list(x = "topright", bty = "n"))
}
```



```{r}
date_range = 'daily'
language = 'Python'
```


```{r}
main <- function(date_range,language){
  
      # Fetch list of URLs within specified date-range
      GIT_URLS <<- API_1_create_urls(date_range)

      # Create data frame of repositories, programming languages, and language percentages
      language_df = create_language_dataframe()
      language_df = create_filtered_top_n_language_dataframe(language, language_df)
      GIT_URLS <<- get_urls_from_list_of_repo_names(language_df)

      # Create data frame of individual repository commits (incl. repository, developer name, email, date-time)
      commits_df = create_commits_dataframe()
      commits_count = count_commits_by_DevRepo(commits_df)

      # Draw graphs
    #  g1 = graph_langauges(languages_df)
    #  g2 = graph_time_of_day(commits_df)
    #  g3 = graph_num_commits(commits_df)
}
```

```{r}
main('daily','Python')
```



